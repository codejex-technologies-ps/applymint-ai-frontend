// Prisma schema for ApplyMint AI
// Migrated from Drizzle ORM to Prisma ORM for better DX and integrations
// This schema integrates with Supabase PostgreSQL database

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER PROFILES AND AUTHENTICATION
// ==========================================

model Profile {
  id        String   @id @db.Uuid
  email     String   @unique
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  phoneNumber String? @map("phone_number")

  // Extended profile fields
  bio               String?  
  location          String?
  website           String?
  linkedinUrl       String?  @map("linkedin_url")
  githubUrl         String?  @map("github_url")
  twitterUrl        String?  @map("twitter_url")
  portfolioUrl      String?  @map("portfolio_url")
  currentPosition   String?  @map("current_position")
  company           String?
  yearsOfExperience Int?     @map("years_of_experience")
  availabilityStatus String? @default("available") @map("availability_status")
  preferredWorkType  String? @default("full_time") @map("preferred_work_type")
  profileVisibility  String? @default("public") @map("profile_visibility")

  // Credit system
  credit Int @default(5)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  resumes            Resume[]
  jobApplications    JobApplication[]
  savedJobs          SavedJob[]
  jobAlerts          JobAlert[]
  interviewSessions  InterviewSession[]
  userAnalytics      UserAnalytic[]
  notifications      Notification[]
  creditTransactions CreditTransaction[]
  userSubscriptions  UserSubscription[]
  userPreferences    UserPreference?

  @@map("profiles")
}

model UserPreference {
  id     String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String  @unique @map("user_id") @db.Uuid
  
  // Job alert preferences
  jobAlertEnabled       Boolean @default(true) @map("job_alert_enabled")
  jobAlertFrequency     String  @default("daily") @map("job_alert_frequency")
  emailNotifications    Boolean @default(true) @map("email_notifications")
  smsNotifications      Boolean @default(false) @map("sms_notifications")
  
  // Job preferences
  preferredJobTypes     String[] @map("preferred_job_types")
  preferredLocations    String[] @map("preferred_locations")
  remoteWorkPreference  Boolean  @default(false) @map("remote_work_preference")
  
  // Salary expectations
  salaryMin      Decimal? @map("salary_min") @db.Decimal
  salaryMax      Decimal? @map("salary_max") @db.Decimal
  salaryCurrency String  @default("USD") @map("salary_currency")
  
  // Privacy settings
  profilePublic         Boolean @default(true) @map("profile_public")
  showContactInfo       Boolean @default(false) @map("show_contact_info")
  allowRecruiterContact Boolean @default(true) @map("allow_recruiter_contact")
  
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model UserAnalytic {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  eventType String   @map("event_type")
  eventData Json?    @map("event_data") @db.Json
  eventDate DateTime @default(now()) @map("event_date") @db.Date
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_analytics")
}

// ==========================================
// COMPANIES AND JOBS
// ==========================================

model Company {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  website     String?
  logoUrl     String?   @map("logo_url")
  industry    String?
  size        String?   // STARTUP, SMALL, MEDIUM, LARGE, ENTERPRISE
  location    String?
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  jobs Job[]

  @@map("companies")
}

model Job {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title               String
  companyId           String?   @map("company_id") @db.Uuid
  location            String
  isRemote            Boolean   @default(false) @map("is_remote")
  jobType             String?   @map("job_type") // FULL_TIME, PART_TIME, CONTRACT, INTERNSHIP, FREELANCE
  experienceLevel     String?   @map("experience_level") // ENTRY, MID, SENIOR, EXECUTIVE
  description         String
  requirements        String[]
  responsibilities    String[]
  benefits            String[]
  salaryMin           Decimal?   @map("salary_min") @db.Decimal
  salaryMax           Decimal?   @map("salary_max") @db.Decimal
  salaryCurrency      String    @default("USD") @map("salary_currency")
  skills              String[]
  postedAt            DateTime  @default(now()) @map("posted_at") @db.Timestamptz(6)
  applicationDeadline DateTime? @map("application_deadline") @db.Timestamptz(6)
  isActive            Boolean   @default(true) @map("is_active")
  externalJobId       String?   @map("external_job_id")
  externalSource      String?   @map("external_source")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  company         Company?         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  applications    JobApplication[]
  savedJobs       SavedJob[]

  @@map("jobs")
}

model JobApplication {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobId       String    @map("job_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  resumeId    String?   @map("resume_id") @db.Uuid
  coverLetter String?   @map("cover_letter")
  status      String    @default("DRAFT") // DRAFT, SUBMITTED, UNDER_REVIEW, INTERVIEW, OFFER, REJECTED, ACCEPTED
  appliedAt   DateTime  @default(now()) @map("applied_at") @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  notes       String?

  // Relations
  job    Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user   Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  resume Resume?  @relation(fields: [resumeId], references: [id])

  @@unique([jobId, userId])
  @@map("job_applications")
}

model SavedJob {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobId   String   @map("job_id") @db.Uuid
  userId  String   @map("user_id") @db.Uuid
  savedAt DateTime @default(now()) @map("saved_at") @db.Timestamptz(6)
  notes   String?

  // Relations
  job  Job     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobId, userId])
  @@map("saved_jobs")
}

model JobAlert {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  title          String
  query          String?
  location       String?
  jobTypes       String[] @map("job_types")
  experienceLevel String? @map("experience_level")
  salaryMin      Decimal?  @map("salary_min") @db.Decimal
  salaryMax      Decimal?  @map("salary_max") @db.Decimal
  isRemote       Boolean  @default(false) @map("is_remote")
  isActive       Boolean  @default(true) @map("is_active")
  frequency      String   @default("daily") // daily, weekly, instant
  lastSent       DateTime? @map("last_sent") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("job_alerts")
}

// ==========================================
// RESUMES AND RELATED CONTENT
// ==========================================

model Resume {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  title      String
  summary    String?
  isDefault  Boolean  @default(false) @map("is_default")
  fileName   String?  @map("file_name")
  fileUrl    String?  @map("file_url")
  fileSize   String?  @map("file_size")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user           Profile          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workExperiences WorkExperience[]
  educations      Education[]
  skills          Skill[]
  certifications  Certification[]
  projects        Project[]
  languages       Language[]
  applications    JobApplication[]

  @@map("resumes")
}

model WorkExperience {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId     String    @map("resume_id") @db.Uuid
  company      String
  position     String
  location     String?
  startDate    DateTime  @map("start_date") @db.Date
  endDate      DateTime? @map("end_date") @db.Date
  isCurrent    Boolean   @default(false) @map("is_current")
  description  String?
  achievements String[]
  skills       String[]
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("work_experiences")
}

model Education {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId      String    @map("resume_id") @db.Uuid
  institution   String
  degree        String?   // HIGH_SCHOOL, ASSOCIATE, BACHELOR, MASTER, DOCTORAL, CERTIFICATE, DIPLOMA, OTHER
  fieldOfStudy  String?   @map("field_of_study")
  startDate     DateTime  @map("start_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date
  gpa           String?
  description   String?
  achievements  String[]
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("educations")
}

model Skill {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId     String   @map("resume_id") @db.Uuid
  name         String
  level        String?  // BEGINNER, INTERMEDIATE, ADVANCED, EXPERT
  yearsOfExp   Int?     @map("years_of_experience")
  endorsements Int      @default(0)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("skills")
}

model Certification {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId      String    @map("resume_id") @db.Uuid
  name          String
  issuingOrg    String    @map("issuing_organization")
  issueDate     DateTime  @map("issue_date") @db.Date
  expiryDate    DateTime? @map("expiry_date") @db.Date
  credentialId  String?   @map("credential_id")
  credentialUrl String?   @map("credential_url")
  description   String?
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("certifications")
}

model Project {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId    String    @map("resume_id") @db.Uuid
  name        String
  description String?
  role        String?
  startDate   DateTime  @map("start_date") @db.Date
  endDate     DateTime? @map("end_date") @db.Date
  url         String?
  skills      String[]
  highlights  String[]
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("projects")
}

model Language {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId    String   @map("resume_id") @db.Uuid
  name        String
  proficiency String   // ELEMENTARY, LIMITED_WORKING, PROFESSIONAL_WORKING, FULL_PROFESSIONAL, NATIVE
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("languages")
}

// ==========================================
// AI INTERVIEW SIMULATOR
// ==========================================

model InterviewSession {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  jobTitle    String   @map("job_title")
  jobLevel    String   @map("job_level")
  status      String   @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, ABANDONED
  overallScore Int?    @map("overall_score")
  feedback    String?
  duration    Int?     // Duration in seconds
  startedAt   DateTime @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user      Profile              @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions InterviewQuestion[]
  responses InterviewResponse[]

  @@map("interview_sessions")
}

model InterviewQuestion {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId  String   @map("session_id") @db.Uuid
  question   String
  category   String   // BEHAVIORAL, TECHNICAL, SITUATIONAL, ROLE_SPECIFIC
  difficulty String   // EASY, MEDIUM, HARD
  order      Int
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  session   InterviewSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  responses InterviewResponse[]

  @@map("interview_questions")
}

model InterviewResponse {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId   String   @map("session_id") @db.Uuid
  questionId  String   @map("question_id") @db.Uuid
  response    String
  score       Int?     // 0-100
  feedback    String?
  strengths   String[]
  improvements String[]
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  session  InterviewSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question InterviewQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("interview_responses")
}

// ==========================================
// NOTIFICATIONS
// ==========================================

model Notification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  type      String    // JOB_ALERT, APPLICATION_UPDATE, INTERVIEW_SCHEDULED, SYSTEM
  title     String
  message   String
  link      String?
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ==========================================
// CREDIT SYSTEM
// ==========================================

model CreditPackage {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  credits     Int
  price       Decimal   @db.Decimal
  currency    String   @default("USD")
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  features    String[]
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("credit_packages")
}

model CreditTransaction {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  type            String   // PURCHASE, USAGE, REFUND, BONUS
  amount          Int      // Positive for credits added, negative for credits used
  balanceAfter    Int      @map("balance_after")
  reason          String?
  featureUsed     String?  @map("feature_used")
  relatedEntityId String?  @map("related_entity_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("credit_transactions")
}

model FeatureCreditCost {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  featureName String   @unique @map("feature_name")
  cost        Int
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("feature_credit_costs")
}

model UserSubscription {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  plan             String    // FREE, BASIC, PREMIUM, ENTERPRISE
  status           String    // ACTIVE, CANCELLED, EXPIRED, PENDING
  startDate        DateTime  @map("start_date") @db.Timestamptz(6)
  endDate          DateTime? @map("end_date") @db.Timestamptz(6)
  autoRenew        Boolean   @default(true) @map("auto_renew")
  stripeCustomerId String?   @map("stripe_customer_id")
  stripeSubscriptionId String? @map("stripe_subscription_id")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_subscriptions")
}
